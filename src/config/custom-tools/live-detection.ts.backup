import { LLMTool } from "../../type";
import { spawn, ChildProcess } from "child_process";
import path from "path";
import { display } from "../../device/display";
import { setLiveDetectionActive } from "../../utils/image";
import fs from "fs";

const DETECTION_SCRIPT = path.join(__dirname, "../../../python/live_detection.py");
const DETECTION_FRAME = "/tmp/whisplay_detection_frame.jpg";

// Global state
let activeDetectionProcess: ChildProcess | null = null;
let detectionUpdateInterval: NodeJS.Timeout | null = null;

const liveDetectionTools: LLMTool[] = [
  {
    type: "function",
    function: {
      name: "startLiveDetection",
      description: "Start live object detection with camera showing real-time bounding boxes around detected objects on the display. Use this when the user wants to see objects being detected in real-time.",
      parameters: {
        type: "object",
        properties: {
          objects: {
            type: "array",
            items: {
              type: "string",
            },
            description: "List of objects to detect (e.g., ['person', 'cup', 'phone']). Can detect thousands of objects - try: person, hand, face, cup, bottle, phone, laptop, keyboard, mouse, book, pen, plant, chair, table, door, window, car, dog, cat, bird, etc.",
          },
          duration: {
            type: "number",
            description: "Optional: How many seconds to run detection (default: continuous until stopped)",
          },
        },
        required: ["objects"],
      },
    },
    func: async (params) => {
      try {
        const { objects, duration } = params;

        if (!Array.isArray(objects) || objects.length === 0) {
          return "[error]Please specify at least one object to detect.";
        }

        // Check if already running
        if (activeDetectionProcess) {
          return "[error]Detection already running. Say 'stop detection' first.";
        }

        console.log(`Starting live detection for: ${objects.join(", ")}`);

        // Build command
        const args = ["start", ...objects];
        if (duration) {
          args.push("--duration", duration.toString());
        }

        // Start detection process
        activeDetectionProcess = spawn("python3", [DETECTION_SCRIPT, ...args]);

        let hasStarted = false;

        // Handle output
        activeDetectionProcess.stdout?.on("data", (data) => {
          const output = data.toString();
          console.log(`Detection: ${output.trim()}`);
          
          if (output.includes("Starting live detection") && !hasStarted) {
            hasStarted = true;
          }
        });

        activeDetectionProcess.stderr?.on("data", (data) => {
          console.error(`Detection error: ${data.toString()}`);
        });

        // Handle exit
        activeDetectionProcess.on("exit", (code) => {
          console.log(`Detection process exited with code ${code}`);
          
          if (detectionUpdateInterval) {
            clearInterval(detectionUpdateInterval);
            detectionUpdateInterval = null;
          }
          
          activeDetectionProcess = null;
          
          // Clear detection state
          setLiveDetectionActive(false);
          
          // Clear display
          display({
            RGB: "#00c8a3",
            emoji: "✅",
            text: "Detection stopped",
            image: "",
          });
        });

        // Mark detection as active to prevent TTS from overwriting display
        setLiveDetectionActive(true);

        // Wait a moment for process to start
        await new Promise((resolve) => setTimeout(resolve, 2000));

        // Clear any text from display immediately
        display({
          RGB: "#00FFFF", // Cyan for detection mode
          text: "",
          emoji: "",
          image: "",
        });

        // Start updating display with detection frames
        detectionUpdateInterval = setInterval(() => {
          if (fs.existsSync(DETECTION_FRAME)) {
            display({
              RGB: "#00FFFF", // Cyan for detection mode
              image: DETECTION_FRAME,
            });
          }
        }, 100); // Update every 100ms for smooth display

        const objectsList = objects.join(", ");
        const durationText = duration ? ` for ${duration} seconds` : " until you say stop";
        
        return `[success]Detection started${durationText} for: ${objectsList}.`;
      } catch (error: any) {
        console.error("Error starting detection:", error);
        
        if (detectionUpdateInterval) {
          clearInterval(detectionUpdateInterval);
          detectionUpdateInterval = null;
        }
        
        activeDetectionProcess = null;
        
        return `[error]Failed to start detection: ${error.message}`;
      }
    },
  },

  {
    type: "function",
    function: {
      name: "stopLiveDetection",
      description: "Stop the currently running live object detection",
      parameters: {},
    },
    func: async (params) => {
      try {
        if (!activeDetectionProcess) {
          return "[error]No detection currently running.";
        }

        console.log("Stopping live detection...");

        // Send stop signal to Python script (it monitors state file)
        const { exec } = require("child_process");
        const { promisify } = require("util");
        const execAsync = promisify(exec);
        
        await execAsync(`python3 ${DETECTION_SCRIPT} stop`);

        // Give it a moment to stop gracefully
        await new Promise((resolve) => setTimeout(resolve, 1000));

        // Force kill if still running
        if (activeDetectionProcess) {
          activeDetectionProcess.kill("SIGTERM");
          activeDetectionProcess = null;
        }

        // Stop display updates
        if (detectionUpdateInterval) {
          clearInterval(detectionUpdateInterval);
          detectionUpdateInterval = null;
        }

        // Clear detection state
        setLiveDetectionActive(false);

        // Clear display
        display({
          RGB: "#00c8a3",
          emoji: "⏹️",
          text: "Detection stopped",
          image: "",
        });

        return "[success]Live detection stopped.";
      } catch (error: any) {
        console.error("Error stopping detection:", error);
        
        // Cleanup anyway
        activeDetectionProcess = null;
        if (detectionUpdateInterval) {
          clearInterval(detectionUpdateInterval);
          detectionUpdateInterval = null;
        }
        setLiveDetectionActive(false);
        
        return `[error]Failed to stop detection cleanly: ${error.message}`;
      }
    },
  },
];

export default liveDetectionTools;

